name: Blog Preview Link

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  comment-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate and find blog slugs
        id: find-slug
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "message=No blog content changes detected!" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Step 1: Detect slugs from both sources
          YAML_SLUGS=()
          FOLDER_SLUGS=()
          
          # Detect slugs from _blog.yml changes
          if echo "$CHANGED_FILES" | grep -q "^_blog.yml$"; then
            while IFS= read -r line; do
              if [[ $line =~ ^[[:space:]]*-[[:space:]]*slug:[[:space:]]*[\"']?([^\"']+)[\"']?$ ]]; then
                YAML_SLUGS+=("${BASH_REMATCH[1]}")
              fi
            done < <(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} _blog.yml 2>/dev/null)
          fi
          
          # Detect slugs from folder changes
          while IFS= read -r file; do
            if [[ $file =~ ^blogs/([^/]+)/content\.md$ ]]; then
              FOLDER_SLUGS+=("${BASH_REMATCH[1]}")
            fi
          done <<< "$CHANGED_FILES"
          
          # Remove duplicates and sort
          YAML_SLUGS=($(printf "%s\n" "${YAML_SLUGS[@]}" | sort -u))
          FOLDER_SLUGS=($(printf "%s\n" "${FOLDER_SLUGS[@]}" | sort -u))
          
          # Step 2: Validate slug consistency
          if [ ${#YAML_SLUGS[@]} -ne ${#FOLDER_SLUGS[@]} ]; then
            echo "error=true" >> $GITHUB_OUTPUT
            echo "message=‚ùå Validation Error: Number of slugs in _blog.yml (${#YAML_SLUGS[@]}) doesn't match number of blog folders (${#FOLDER_SLUGS[@]})" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check if all slugs match
          for yaml_slug in "${YAML_SLUGS[@]}"; do
            found=false
            for folder_slug in "${FOLDER_SLUGS[@]}"; do
              if [ "$yaml_slug" = "$folder_slug" ]; then
                found=true
                break
              fi
            done
            if [ "$found" = false ]; then
              echo "error=true" >> $GITHUB_OUTPUT
              echo "message=‚ùå Validation Error: Slug mismatch found. The slug in _blog.yml must exactly match the folder name in blogs/ directory.\n\nFound in _blog.yml: \`${YAML_SLUGS[*]}\`\nFound in blogs/: \`${FOLDER_SLUGS[*]}\`" >> $GITHUB_OUTPUT
              exit 1
            fi
          done
          
          # Step 3: Determine if blogs are new or edited
          NEW_BLOGS=()
          EDITED_BLOGS=()
          
          for slug in "${YAML_SLUGS[@]}"; do
            if git ls-tree -r --name-only ${{ github.event.pull_request.base.sha }} | grep -q "^blogs/$slug/"; then
              EDITED_BLOGS+=("$slug")
            else
              NEW_BLOGS+=("$slug")
            fi
          done
          
          # Prepare message based on changes
          if [ ${#NEW_BLOGS[@]} -gt 0 ] && [ ${#EDITED_BLOGS[@]} -gt 0 ]; then
            NEW_BLOGS_STR=$(printf ",\`%s\`" "${NEW_BLOGS[@]}" | cut -c2-)
            EDITED_BLOGS_STR=$(printf ",\`%s\`" "${EDITED_BLOGS[@]}" | cut -c2-)
            echo "message=Multiple changes detected:\n\nNew blogs: ${NEW_BLOGS_STR}\n\nEdits in: ${EDITED_BLOGS_STR}" >> $GITHUB_OUTPUT
            echo "slugs=${NEW_BLOGS[*]}" >> $GITHUB_OUTPUT
          elif [ ${#NEW_BLOGS[@]} -gt 0 ]; then
            NEW_BLOGS_STR=$(printf ",\`%s\`" "${NEW_BLOGS[@]}" | cut -c2-)
            echo "message=New blogs detected: ${NEW_BLOGS_STR}" >> $GITHUB_OUTPUT
            echo "slugs=${NEW_BLOGS[*]}" >> $GITHUB_OUTPUT
          elif [ ${#EDITED_BLOGS[@]} -gt 0 ]; then
            EDITED_BLOGS_STR=$(printf ",\`%s\`" "${EDITED_BLOGS[@]}" | cut -c2-)
            echo "message=Edits in existing blogs detected: ${EDITED_BLOGS_STR}" >> $GITHUB_OUTPUT
            echo "slugs=${EDITED_BLOGS[*]}" >> $GITHUB_OUTPUT
          else
            echo "message=No blog content changes detected!" >> $GITHUB_OUTPUT
          fi

      - name: Delete old preview comments
        if: steps.find-slug.outputs.error != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Delete all comments from the bot that contain "Preview Blog"
            const previewComments = comments.filter(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('Preview Blog')
            );
            
            for (const comment of previewComments) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }

      - name: Comment preview link or status
        if: steps.find-slug.outputs.error != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = '${{ steps.find-slug.outputs.message }}';
            const slugs = '${{ steps.find-slug.outputs.slugs }}'.split(' ');
            const branch = context.payload.pull_request.head.ref;
            const owner = context.payload.pull_request.head.repo.owner.login;
            const repo = context.payload.pull_request.head.repo.name;
            
            const blogListUrl = `https://www.binapani.com/draft/blog?preview=${branch}&owner=${owner}&repo=${repo}`;
            
            let body = `## üëÄ Preview Blog\n\n${message}\n\n`;
            
            if (!slugs[0]) {
              body += `üîç Please check the [guidelines](https://github.com/binapani-edu/blog/blob/main/README.md) for instructions on how to add your blog.\n\n`;
            } else {
              body += `## üîç Preview Links\n\n`;
              body += `üìö [Blog List Preview](${blogListUrl}) - your blog card in the list of all blogs\n`;
              
              // Create content preview links for each blog
              const contentLinks = slugs.map(slug => 
                `[${slug}](${`https://www.binapani.com/draft/blog/${slug}?preview=${branch}&owner=${owner}&repo=${repo}`})`
              ).join(', ');
              
              body += `üìù Blog Content Preview: ${contentLinks}\n\n`;
              body += `These links will be updated automatically when you push new changes.\n\n`;
            }
            
            body += ` ---\n\n`;
            body += `Useful Links | [Binapani Blog](https://www.binapani.com/blog) | [Binapani Blog Preview Tool](https://www.binapani.com/draft/blog)`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Comment validation error
        if: steps.find-slug.outputs.error == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = '${{ steps.find-slug.outputs.message }}';
            
            let body = `## ‚ùå Blog Validation Failed\n\n${message}\n\n`;
            body += `Please ensure that:\n`;
            body += `1. The slug in _blog.yml exactly matches the folder name in blogs/ directory\n`;
            body += `2. Each blog has both a folder in blogs/ and an entry in _blog.yml\n`;
            body += `3. The folder name and slug are in kebab-case (lowercase with hyphens)\n\n`;
            body += `Check the [contribution guidelines](https://github.com/binapani-edu/blog/blob/main/README.md) for more details.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
